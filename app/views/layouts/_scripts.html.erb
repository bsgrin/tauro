<script type="text/javascript">

  function totalHeight (node) {
    return parseInt(node.css('height')) + parseInt(node.css('margin-top')) + parseInt(node.css('margin-bottom'))
  }
  
  //handles fading of the thumbnails
  function fadeElem(elems, index) {
    var elem = $( '#' + elems[index].id )
    elem.fadeIn(400, function () {
      setTimeout(function () { 
        elem.fadeOut(400, function () {
          fadeElem( elems, (index + 1) % elems.length )
        })
      }, 5000)
    })
  }

  //handles fading and grayscale of images
  function grayImages (small, medium, galleryID, imageIndex) {
    var mainArt = $('#mainArt')
    var preloadedImages = document.preloaded_images
    var preloadedExist = !!(preloadedImages && preloadedImages[galleryID])
    var smallImage, newArt

    if (preloadedExist) {
      smallImage = $('.thumb-' + imageIndex)
      newArt = $(preloadedImages[galleryID][imageIndex])
    } else {
      smallImage = $('img[src="' + small + '"]');
      newArt = $('img[src="' + medium + '"]')
    }

    var allColored = $(".colored");
    $.each(allColored, function (index) { 
      $(allColored[index]).addClass("gray").removeClass("colored")
    })
    smallImage.removeClass('gray').addClass('colored')

    mainArt.fadeTo(400, 0.01, function () {
      if (preloadedExist) {
        newArt
          .attr('id', mainArt.attr('id'))
          .css('opacity', 0.01)
        $('#mainArtContainer').empty().append(newArt)
        newArt.fadeTo(400, 1)
      } else {
        mainArt.attr('src', medium).one('load', function() {  
          mainArt.fadeTo(400, 1)
        })
      }
    })
  }

  //preload big images of galleries
  function preloadImages(galleryID, imagesToPreload) {
    if (!document.preloaded_images)
      document.preloaded_images = []
    if (document.preloaded_images[galleryID] && document.preloaded_images[galleryID].length > 0)
      return

    $.each(imagesToPreload, function(index) {
      if (!document.preloaded_images[galleryID])
        document.preloaded_images[galleryID] = []
      var image = new Image
      image.src = imagesToPreload[index]
      document.preloaded_images[galleryID].push(image)
    })
  }

  //adjust LEFT of the main container and WIDTH of side bar
  function adjustWidths() {
    var container = $('#container')
    var left = ( screen.width - container.width() ) / 2;
    container.css('left', left)
    $('.side-bar').css('width', left)
  }

  function makeActive(index) {
    var linksToGalleries = $('.link-to-gallery')
    linksToGalleries.removeClass('active-g')
    var target = $(linksToGalleries[index])
    target.addClass('active-g')
    var up = $('#up'), down = $('#down'), prevIndex = prevGalleryIndex(index), nextIndex = nextGalleryIndex(index)
      prevGallery = linksToGalleries[prevIndex], nextGallery = linksToGalleries[nextIndex]
    up.attr('next', prevGalleryIndex(index)).attr('href', "galleries/" + prevGallery.id.slice(1))
    down.attr('next', nextGalleryIndex(index)).attr('href', "galleries/" + nextGallery.id.slice(1))

    $(".side-bar .inner").animate({'margin-top': 180 - totalHeight( $(linksToGalleries[prevIndex]).parent() ) * index}, 300)
  }

  function nextGalleryIndex(index) {
    return index == $('.link-to-gallery').length - 1 ? 0 : index + 1
  }

  function prevGalleryIndex(index) {
    return index == 0 ? $('.link-to-gallery').length - 1 : index - 1
  }

  function adjustSideBarAjaxCompleted(activeControl) {
    var target = $(activeControl)
    var targetClasses = target.attr('class').split(/\s+/)
    if (targetClasses.indexOf('link-to-gallery') != -1) {
      var linksToGalleries = $('.link-to-gallery')
      var ids = []
      $.each(linksToGalleries, function(i) { ids.push(linksToGalleries[i].id) })
      var next = ids.indexOf(activeControl.id)
    } else if (targetClasses.indexOf('arrow-to-gallery') != -1)
      var next = parseInt(target.attr('next'))
    makeActive(next)
  }

  $(function () {
    adjustWidths()

    var linksToGalleries = $('.link-to-gallery')
    var activeLink = $('.active-g')
    var ids = []
    $.each(linksToGalleries, function(i) { ids.push(linksToGalleries[i].id) })
    var activeIndex = ids.indexOf(activeLink.attr('id'))
    $(".side-bar .inner").animate({'margin-top': 180 - totalHeight( $(linksToGalleries[prevGalleryIndex(activeIndex)]).parent() ) * activeIndex}, 300)

    $('.load-g').on("ajax:complete", function (xhr, status, error) { adjustSideBarAjaxCompleted(this) })
  })

  $(window).bind('load', function() {

  });

</script>